<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ TWS-Bets - Lottery & Gambling Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a0a 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, #8B0000 0%, #B22222 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #FFD700;
        }

        .header h1 {
            margin: 0;
            color: #FFD700;
            font-size: 2rem;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #222;
            border-bottom: 1px solid #444;
            overflow-x: auto;
        }

        .nav button {
            padding: 10px 20px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        .nav button.active {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: rgba(26, 26, 26, 0.9);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #FFD700;
            margin-bottom: 20px;
            border-bottom: 2px solid #660000;
            padding-bottom: 10px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #8B0000, #B22222);
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #B22222, #8B0000);
        }

        .btn-admin {
            background: linear-gradient(45deg, #4B0082, #8A2BE2);
        }

        /* Inputs */
        input, select {
            padding: 12px;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 5px;
            margin: 8px 0;
            width: 100%;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(139, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #8B0000;
        }

        /* Tier Cards */
        .tier-card {
            background: rgba(40, 40, 40, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #FFD700;
        }

        /* Bet Items */
        .bet-item {
            background: rgba(50, 50, 50, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #FFA500;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #444;
            margin-top: 40px;
            color: #aaa;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            border: 2px solid #FFD700;
        }

        /* Utility Classes */
        .hidden { display: none; }
        .text-success { color: #00FF00; }
        .text-danger { color: #FF4444; }
        .text-warning { color: #FFA500; }
        .text-gold { color: #FFD700; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1>üé≤ TWS-BETS</h1>
            <p style="margin: 5px 0 0 0; color: #ccc;">High Stakes Lottery & Betting</p>
        </div>
        <div id="userInfo"></div>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <button onclick="showPage('home')" class="active">üè† Home</button>
        <button onclick="showPage('lottery')">üé´ Lottery</button>
        <button onclick="showPage('bets')">ü§ù Direct Bets</button>
        <button onclick="showPage('history')">üìú History</button>
        <button onclick="showPage('profile')">üë§ Profile</button>
        <button onclick="toggleAdmin()" class="btn-admin">‚öôÔ∏è Admin</button>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Home Page -->
        <div id="homePage" class="page">
            <div class="card">
                <h2>Welcome to TWS-Bets</h2>
                <p>The premier lottery and betting platform for That War Server community.</p>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üí∞ Total in Play</h3>
                        <p id="totalMoney" class="text-gold" style="font-size: 24px;">$0</p>
                    </div>
                    <div class="stat-card">
                        <h3>üé≤ Active Players</h3>
                        <p id="totalPlayers" class="text-success" style="font-size: 24px;">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>‚ö° Active Bets</h3>
                        <p id="activeBets" class="text-warning" style="font-size: 24px;">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>‚ö†Ô∏è Unpaid</h3>
                        <p id="unpaidBets" class="text-danger" style="font-size: 24px;">0</p>
                    </div>
                </div>

                <div id="loginPrompt" style="text-align: center; margin-top: 30px;">
                    <h3>Ready to play?</h3>
                    <button onclick="showPage('login')" class="btn">Login / Register to Start</button>
                </div>

                <div id="userWelcome" class="hidden" style="text-align: center; margin-top: 30px;">
                    <h3>Welcome back, <span id="welcomeName"></span>!</h3>
                    <button onclick="showPage('lottery')" class="btn">üé´ Buy Lottery Tickets</button>
                    <button onclick="showPage('bets')" class="btn">ü§ù Place Bets</button>
                </div>
            </div>

            <div class="card">
                <h3>üéØ How It Works</h3>
                <ol style="margin: 15px 0 0 20px;">
                    <li><strong>Register</strong> with your display name</li>
                    <li><strong>Accept Terms</strong> (mandatory for betting)</li>
                    <li><strong>Buy Lottery Tickets</strong> ($50-$500 tiers)</li>
                    <li><strong>Create/Accept Direct Bets</strong> (items or money)</li>
                    <li><strong>Honor your bets</strong> - Admins enforce payments!</li>
                </ol>
            </div>
        </div>

        <!-- Login/Register Page -->
        <div id="loginPage" class="page hidden">
            <div class="card">
                <h2>Login / Register</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Login Form -->
                    <div>
                        <h3>Login</h3>
                        <input type="text" id="loginUsername" placeholder="Username" class="input">
                        <input type="password" id="loginPassword" placeholder="Password" class="input">
                        <button onclick="login()" class="btn">Login</button>
                    </div>

                    <!-- Register Form -->
                    <div>
                        <h3>Register</h3>
                        <input type="text" id="regUsername" placeholder="Username" class="input">
                        <input type="text" id="regDisplayName" placeholder="Display Name (in-game)" class="input">
                        <input type="password" id="regPassword" placeholder="Password" class="input">
                        <button onclick="register()" class="btn">Register</button>
                    </div>
                </div>
                <p style="font-size: 12px; color: #aaa; margin-top: 20px;">
                    Note: This is a demo. Data is saved in your browser's localStorage.
                </p>
            </div>
        </div>

        <!-- Lottery Page -->
        <div id="lotteryPage" class="page hidden">
            <div class="card">
                <h2>üé´ Lottery Tiers</h2>
                <p>Buy tickets ($50-$500). Game starts with 2+ players. Max 50 tickets per player.</p>
                
                <div id="ticketCounter" class="tier-card hidden">
                    <strong>Your Tickets: <span id="userTickets">0</span>/50</strong>
                </div>

                <div id="lotteryTiers"></div>
            </div>
        </div>

        <!-- Bets Page -->
        <div id="betsPage" class="page hidden">
            <div class="card">
                <h2>ü§ù Create Direct Bet</h2>
                <input type="text" id="betItem" placeholder="Item Name (e.g., Diamond Blocks)" class="input">
                <input type="number" id="betAmount" placeholder="Amount (e.g., 10)" class="input">
                <input type="number" id="betValue" placeholder="Equivalent Money Value ($)" class="input">
                <input type="text" id="betDescription" placeholder="Bet Description" class="input">
                <button onclick="createBet()" class="btn">Create Bet</button>
            </div>

            <div class="card">
                <h2>Available Bets</h2>
                <div id="availableBets"></div>
            </div>
        </div>

        <!-- History Page -->
        <div id="historyPage" class="page hidden">
            <div class="card">
                <h2>üìú Bet History</h2>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="page hidden">
            <div class="card">
                <h2>üë§ Your Profile</h2>
                <div class="stats-grid" id="profileStats"></div>
                
                <div style="margin-top: 20px;">
                    <h3>Terms Status</h3>
                    <div id="termsStatus"></div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>Your Active Games</h3>
                    <div id="activeGames"></div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="page hidden">
            <div class="card">
                <h2 class="text-gold">üëë Admin Panel</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Players</h3>
                        <p id="adminTotalPlayers" style="font-size: 24px;">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Bets</h3>
                        <p id="adminTotalBets" style="font-size: 24px;">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Unpaid Bets</h3>
                        <p id="adminUnpaid" style="font-size: 24px; color: #FF4444;">0</p>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>Danger Zone</h3>
                    <button onclick="resetAllData()" class="btn" style="background: #8B0000;">üí£ Reset All Data</button>
                    <p style="font-size: 12px; color: #aaa; margin-top: 10px;">
                        Warning: This will delete ALL data!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="termsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-gold">üìú TERMS OF USE</h2>
            <div style="margin: 20px 0;">
                <p><strong>By accepting these terms, you agree to:</strong></p>
                <ol>
                    <li>All bets and lottery outcomes are FINAL</li>
                    <li>If you lose, you MUST transfer the agreed items/money IN-GAME within 48 hours</li>
                    <li>Failure to pay will result in admin intervention</li>
                    <li>Repeated failure to pay may result in temporary or permanent ban</li>
                    <li>You must be 18+ or have parental permission to participate</li>
                    <li>No real money gambling - only in-game items</li>
                    <li>Admins have final say in all disputes</li>
                </ol>
                <p class="text-danger" style="margin-top: 20px;">
                    ‚ö†Ô∏è <strong>WARNING:</strong> If you don't pay your losses, admins WILL enforce rules!
                </p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="acceptTerms()" class="btn">‚úÖ I Accept Terms</button>
                <button onclick="closeModal('termsModal')" class="btn" style="background: #444;">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>TWS-Bets ‚Ä¢ For That War Server Community ‚Ä¢ All bets are enforced by admins</p>
        <p>‚ö†Ô∏è This is a demonstration system. Data is stored in your browser's localStorage.</p>
    </div>

    <script>
        // Game Data
        let players = JSON.parse(localStorage.getItem('tws_players')) || [];
        let lotteryTiers = JSON.parse(localStorage.getItem('tws_tiers')) || [
            { id: 1, name: "Bronze Tier", price: 50, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
            { id: 2, name: "Silver Tier", price: 150, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
            { id: 3, name: "Gold Tier", price: 300, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
            { id: 4, name: "Diamond Tier", price: 500, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" }
        ];
        let bets = JSON.parse(localStorage.getItem('tws_bets')) || [];
        let currentUser = JSON.parse(localStorage.getItem('tws_currentUser')) || null;
        let adminMode = false;

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('tws_players', JSON.stringify(players));
            localStorage.setItem('tws_tiers', JSON.stringify(lotteryTiers));
            localStorage.setItem('tws_bets', JSON.stringify(bets));
            if (currentUser) {
                localStorage.setItem('tws_currentUser', JSON.stringify(currentUser));
            } else {
                localStorage.removeItem('tws_currentUser');
            }
        }

        // Page Navigation
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            // Show selected page
            document.getElementById(pageName + 'Page').classList.remove('hidden');
            document.querySelector(`button[onclick="showPage('${pageName}')"]`).classList.add('active');
            
            // Update page content
            updatePage(pageName);
        }

        function updatePage(pageName) {
            switch(pageName) {
                case 'home':
                    updateHomePage();
                    break;
                case 'lottery':
                    updateLotteryPage();
                    break;
                case 'bets':
                    updateBetsPage();
                    break;
                case 'history':
                    updateHistoryPage();
                    break;
                case 'profile':
                    updateProfilePage();
                    break;
                case 'admin':
                    updateAdminPage();
                    break;
            }
            updateUserInfo();
        }

        // User Functions
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = players.find(p => p.username === username && p.password === password);
            if (user) {
                currentUser = user;
                saveData();
                alert(`Welcome back, ${user.displayName}!`);
                showPage('home');
            } else {
                alert('Invalid credentials!');
            }
        }

        function register() {
            const username = document.getElementById('regUsername').value;
            const displayName = document.getElementById('regDisplayName').value;
            const password = document.getElementById('regPassword').value;
            
            if (!username || !displayName || !password) {
                alert('Please fill all fields!');
                return;
            }
            
            if (players.find(p => p.username === username)) {
                alert('Username already exists!');
                return;
            }
            
            const newUser = {
                id: Date.now(),
                username,
                displayName,
                password,
                gamesPlayed: 0,
                gamesWon: 0,
                gamesLost: 0,
                totalWinnings: 0,
                totalLosses: 0,
                ticketsBought: 0,
                reputation: 100,
                joinDate: new Date().toISOString(),
                agreedToTerms: false
            };
            
            players.push(newUser);
            currentUser = newUser;
            saveData();
            alert('Registration successful!');
            showPage('home');
        }

        function logout() {
            currentUser = null;
            saveData();
            alert('Logged out!');
            showPage('home');
        }

        // Lottery Functions
        function updateLotteryPage() {
            let html = '';
            
            lotteryTiers.forEach(tier => {
                const canBuy = currentUser && 
                              currentUser.ticketsBought < 50 && 
                              tier.soldTickets < 100 &&
                              !tier.players.find(p => p.playerId === currentUser.id);
                
                html += `
                    <div class="tier-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0 0 5px 0; color: #FFD700">${tier.name}</h3>
                                <p style="margin: 0; font-size: 14px">
                                    <strong>Price:</strong> $${tier.price} | 
                                    <strong>Tickets:</strong> ${tier.soldTickets}/100 | 
                                    <strong>Status:</strong> ${tier.status.toUpperCase()}
                                </p>
                                <p style="margin: 5px 0; font-size: 12px; color: #aaa">
                                    Players: ${tier.players.map(p => p.playerName).join(', ') || 'None yet'}
                                </p>
                            </div>
                            <div>
                                <button onclick="buyTicket(${tier.id})" class="btn" ${!canBuy ? 'disabled style="opacity:0.5"' : ''}>
                                    Buy Ticket ($${tier.price})
                                </button>
                                ${tier.status === 'active' ? '<div style="margin-top:5px;color:#00FF00">‚ö° DRAWING SOON!</div>' : ''}
                                ${tier.winner ? `<div style="margin-top:5px;color:#FFD700">üèÜ Winner: ${tier.winner}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('lotteryTiers').innerHTML = html;
            
            // Update ticket counter
            if (currentUser) {
                document.getElementById('ticketCounter').classList.remove('hidden');
                document.getElementById('userTickets').textContent = currentUser.ticketsBought;
            }
        }

        function buyTicket(tierId) {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            if (!currentUser.agreedToTerms) {
                showModal('termsModal');
                return;
            }
            
            const tierIndex = lotteryTiers.findIndex(t => t.id === tierId);
            if (tierIndex === -1) return;
            
            const tier = lotteryTiers[tierIndex];
            
            // Check limits
            if (currentUser.ticketsBought >= 50) {
                alert('You have reached the maximum of 50 tickets!');
                return;
            }
            
            if (tier.players.find(p => p.playerId === currentUser.id)) {
                alert('You already have a ticket in this tier!');
                return;
            }
            
            if (tier.soldTickets >= 100) {
                alert('This tier is sold out!');
                return;
            }
            
            // Add player to tier
            tier.players.push({
                playerId: currentUser.id,
                playerName: currentUser.displayName,
                ticketNumber: tier.soldTickets + 1,
                purchaseTime: new Date().toISOString()
            });
            
            tier.soldTickets++;
            
            // Check if we have 2+ players to activate
            if (tier.players.length >= 2 && tier.status === 'waiting') {
                tier.status = 'active';
                setTimeout(() => drawLottery(tierId), 30000); // 30 seconds for demo
            }
            
            // Update user
            const userIndex = players.findIndex(p => p.id === currentUser.id);
            players[userIndex].ticketsBought++;
            currentUser.ticketsBought++;
            
            saveData();
            updateLotteryPage();
            alert(`Ticket purchased for ${tier.name} ($${tier.price})!`);
        }

        function drawLottery(tierId) {
            const tierIndex = lotteryTiers.findIndex(t => t.id === tierId);
            const tier = lotteryTiers[tierIndex];
            
            if (!tier || tier.players.length < 2) return;
            
            // Random winner
            const winnerIndex = Math.floor(Math.random() * tier.players.length);
            const winner = tier.players[winnerIndex];
            const loser = tier.players.find(p => p.playerId !== winner.playerId);
            
            // Create bet record
            const newBet = {
                id: Date.now(),
                type: 'lottery',
                tier: tier.name,
                amount: tier.price,
                players: tier.players.map(p => ({
                    id: p.playerId,
                    name: p.playerName
                })),
                winner: { id: winner.playerId, name: winner.playerName },
                loser: { id: loser.playerId, name: loser.playerName },
                status: 'pending_payment',
                created: new Date().toISOString(),
                dueDate: new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString()
            };
            
            bets.push(newBet);
            
            // Update players
            const winnerIndexP = players.findIndex(p => p.id === winner.playerId);
            const loserIndexP = players.findIndex(p => p.id === loser.playerId);
            
            if (winnerIndexP !== -1) {
                players[winnerIndexP].gamesPlayed++;
                players[winnerIndexP].gamesWon++;
                players[winnerIndexP].totalWinnings += tier.price;
                players[winnerIndexP].reputation = Math.min(100, players[winnerIndexP].reputation + 5);
            }
            
            if (loserIndexP !== -1) {
                players[loserIndexP].gamesPlayed++;
                players[loserIndexP].gamesLost++;
                players[loserIndexP].totalLosses += tier.price;
                players[loserIndexP].reputation = Math.max(0, players[loserIndexP].reputation - 10);
            }
            
            // Update tier
            tier.status = 'completed';
            tier.winner = winner.playerName;
            tier.drawTime = new Date().toISOString();
            
            // Update current user if involved
            if (currentUser && (currentUser.id === winner.playerId || currentUser.id === loser.playerId)) {
                const userIndex = players.findIndex(p => p.id === currentUser.id);
                currentUser = players[userIndex];
            }
            
            saveData();
            updateLotteryPage();
            alert(`üéâ Lottery Draw Complete! Winner: ${winner.playerName} wins $${tier.price}!`);
        }

        // Bet Functions
        function updateBetsPage() {
            let html = '';
            const availableBets = bets.filter(b => b.type === 'direct' && b.status === 'waiting');
            
            if (availableBets.length === 0) {
                html = '<p>No available bets. Create one above!</p>';
            } else {
                availableBets.forEach(bet => {
                    const canAccept = currentUser && currentUser.id !== bet.creatorId;
                    html += `
                        <div class="bet-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0">${bet.description || `Bet for ${bet.itemAmount} ${bet.itemName}`}</h4>
                                    <p style="margin: 0; font-size: 14px">
                                        <strong>Value:</strong> $${bet.moneyValue} | 
                                        <strong>Created by:</strong> ${bet.creatorName} |
                                        <strong>Items:</strong> ${bet.itemAmount} ${bet.itemName}
                                    </p>
                                </div>
                                <button onclick="acceptBet(${bet.id})" class="btn" ${!canAccept ? 'disabled style="opacity:0.5"' : ''}>
                                    Accept Bet
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('availableBets').innerHTML = html;
        }

        function createBet() {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            const itemName = document.getElementById('betItem').value;
            const itemAmount = parseInt(document.getElementById('betAmount').value);
            const moneyValue = parseInt(document.getElementById('betValue').value);
            const description = document.getElementById('betDescription').value;
            
            if (!itemName || !itemAmount || !moneyValue) {
                alert('Please fill all required fields!');
                return;
            }
            
            const newBet = {
                id: Date.now(),
                type: 'direct',
                creatorId: currentUser.id,
                creatorName: currentUser.displayName,
                itemName,
                itemAmount,
                moneyValue,
                description,
                status: 'waiting',
                acceptorId: null,
                acceptorName: null,
                winner: null,
                loser: null,
                created: new Date().toISOString(),
                termsAccepted: false
            };
            
            bets.push(newBet);
            saveData();
            updateBetsPage();
            
            // Clear form
            document.getElementById('betItem').value = '';
            document.getElementById('betAmount').value = '';
            document.getElementById('betValue').value = '';
            document.getElementById('betDescription').value = '';
            
            alert('Bet created! Waiting for someone to accept...');
        }

        function acceptBet(betId) {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            const betIndex = bets.findIndex(b => b.id === betId);
            if (betIndex === -1) return;
            
            const bet = bets[betIndex];
            
            if (bet.creatorId === currentUser.id) {
                alert('Cannot accept your own bet!');
                return;
            }
            
            if (!currentUser.agreedToTerms) {
                showModal('termsModal');
                return;
            }
            
            // Determine winner (50/50)
            const isCreatorWinner = Math.random() > 0.5;
            const winnerId = isCreatorWinner ? bet.creatorId : currentUser.id;
            const winnerName = isCreatorWinner ? bet.creatorName : currentUser.displayName;
            const loserId = isCreatorWinner ? currentUser.id : bet.creatorId;
            const loserName = isCreatorWinner ? currentUser.displayName : bet.creatorName;
            
            // Update bet
            bets[betIndex].status = 'completed';
            bets[betIndex].acceptorId = currentUser.id;
            bets[betIndex].acceptorName = currentUser.displayName;
            bets[betIndex].winner = { id: winnerId, name: winnerName };
            bets[betIndex].loser = { id: loserId, name: loserName };
            bets[betIndex].completed = new Date().toISOString();
            bets[betIndex].dueDate = new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString();
            
            // Update players
            const winnerIndex = players.findIndex(p => p.id === winnerId);
            const loserIndex = players.findIndex(p => p.id === loserId);
            
            if (winnerIndex !== -1) {
                players[winnerIndex].gamesPlayed++;
                players[winnerIndex].gamesWon++;
                players[winnerIndex].totalWinnings += bet.moneyValue;
                players[winnerIndex].reputation = Math.min(100, players[winnerIndex].reputation + 3);
            }
            
            if (loserIndex !== -1) {
                players[loserIndex].gamesPlayed++;
                players[loserIndex].gamesLost++;
                players[loserIndex].totalLosses += bet.moneyValue;
                players[loserIndex].reputation = Math.max(0, players[loserIndex].reputation - 7);
            }
            
            // Update current user if involved
            if (currentUser.id === winnerId || currentUser.id === loserId) {
                const userIndex = players.findIndex(p => p.id === currentUser.id);
                currentUser = players[userIndex];
            }
            
            saveData();
            updateBetsPage();
            alert(`Bet accepted! ${winnerName} wins ${bet.itemAmount} ${bet.itemName} (or $${bet.moneyValue})!`);
        }

        // History Functions
        function updateHistoryPage() {
            let html = '';
            const completedBets = bets.filter(b => b.status !== 'waiting');
            
            if (completedBets.length === 0) {
                html = '<p>No history yet.</p>';
            } else {
                completedBets.forEach(bet => {
                    const statusColor = bet.status === 'paid' ? '#00FF00' : 
                                      bet.status === 'pending_payment' ? '#FF4444' : 
                                      bet.status === 'admin_enforced' ? '#8A2BE2' : '#FFA500';
                    
                    html += `
                        <div class="bet-item" style="border-left-color: ${statusColor}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0">
                                        ${bet.type === 'lottery' ? `üé´ ${bet.tier} Lottery` : `ü§ù ${bet.itemAmount} ${bet.itemName}`}
                                    </h4>
                                    <p style="margin: 0; font-size: 14px">
                                        <strong>Amount:</strong> $${bet.moneyValue || bet.amount} | 
                                        <strong>Winner:</strong> ${bet.winner?.name} | 
                                        <strong>Loser:</strong> ${bet.loser?.name} |
                                        <strong>Status:</strong> ${bet.status.replace('_', ' ').toUpperCase()}
                                    </p>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #aaa">
                                        Created: ${new Date(bet.created).toLocaleDateString()}
                                    </p>
                                </div>
                                <div>
                                    ${bet.status === 'pending_payment' && currentUser?.id === bet.loser?.id ? 
                                        `<button onclick="markAsPaid(${bet.id})" class="btn">Mark as Paid</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('historyList').innerHTML = html;
        }

        function markAsPaid(betId) {
            const betIndex = bets.findIndex(b => b.id === betId);
            if (betIndex !== -1) {
                bets[betIndex].status = 'paid';
                saveData();
                updateHistoryPage();
                alert('Marked as paid! Thank you for honoring the bet.');
            }
        }

        // Profile Functions
        function updateProfilePage() {
            if (!currentUser) {
                showPage('home');
                return;
            }
            
            // Stats grid
            document.getElementById('profileStats').innerHTML = `
                <div class="stat-card">
                    <h3>Games Played</h3>
                    <p style="font-size: 24px">${currentUser.gamesPlayed}</p>
                </div>
                <div class="stat-card">
                    <h3>Wins / Losses</h3>
                    <p style="font-size: 24px">${currentUser.gamesWon} / ${currentUser.gamesLost}</p>
                </div>
                <div class="stat-card">
                    <h3>Total Winnings</h3>
                    <p style="font-size: 24px; color: #00FF00">$${currentUser.totalWinnings}</p>
                </div>
                <div class="stat-card">
                    <h3>Total Losses</h3>
                    <p style="font-size: 24px; color: #FF4444">$${currentUser.totalLosses}</p>
                </div>
                <div class="stat-card">
                    <h3>Reputation</h3>
                    <p style="font-size: 24px; color: ${currentUser.reputation >= 70 ? '#00FF00' : currentUser.reputation >= 40 ? '#FFA500' : '#FF4444'}">
                        ${currentUser.reputation}/100
                    </p>
                </div>
                <div class="stat-card">
                    <h3>Tickets Bought</h3>
                    <p style="font-size: 24px">${currentUser.ticketsBought}/50</p>
                </div>
            `;
            
            // Terms status
            document.getElementById('termsStatus').innerHTML = currentUser.agreedToTerms ? 
                '<p class="text-success">‚úÖ Terms accepted. You can participate in all games.</p>' :
                `<div>
                    <p class="text-danger">‚ùå You must accept terms before betting!</p>
                    <button onclick="showModal(\'termsModal\')" class="btn">Read & Accept Terms</button>
                </div>`;
            
            // Active games
            const activeGames = bets.filter(b => 
                (b.winner?.id === currentUser.id || b.loser?.id === currentUser.id) && 
                b.status === 'pending_payment'
            );
            
            if (activeGames.length === 0) {
                document.getElementById('activeGames').innerHTML = '<p>No pending payments.</p>';
            } else {
                let gamesHtml = '';
                activeGames.forEach(bet => {
                    const isLoser = bet.loser?.id === currentUser.id;
                    gamesHtml += `
                        <div style="background: #8B0000; padding: 10px; border-radius: 5px; margin-bottom: 10px">
                            <p style="margin: 0">
                                ${isLoser ? '‚ö†Ô∏è YOU OWE: ' : 'üéâ YOU WON: '}
                                $${bet.moneyValue || bet.amount} ${bet.type === 'lottery' ? 'in lottery' : `for ${bet.itemAmount} ${bet.itemName}`}
                            </p>
                            ${isLoser ? `<button onclick="markAsPaid(${bet.id})" class="btn" style="margin-top: 10px">Mark as Paid</button>` : ''}
                        </div>
                    `;
                });
                document.getElementById('activeGames').innerHTML = gamesHtml;
            }
        }

        // Admin Functions
        function toggleAdmin() {
            adminMode = !adminMode;
            if (adminMode) {
                showPage('admin');
            } else {
                showPage('home');
            }
        }

        function updateAdminPage() {
            document.getElementById('adminTotalPlayers').textContent = players.length;
            document.getElementById('adminTotalBets').textContent = bets.length;
            document.getElementById('adminUnpaid').textContent = bets.filter(b => b.status === 'pending_payment').length;
        }

        function resetAllData() {
            if (confirm('Are you sure? This will delete ALL data including players, bets, and lottery tiers!')) {
                localStorage.clear();
                players = [];
                lotteryTiers = [
                    { id: 1, name: "Bronze Tier", price: 50, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
                    { id: 2, name: "Silver Tier", price: 150, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
                    { id: 3, name: "Gold Tier", price: 300, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
                    { id: 4, name: "Diamond Tier", price: 500, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" }
                ];
                bets = [];
                currentUser = null;
                adminMode = false;
                saveData();
                alert('All data has been reset!');
                showPage('home');
            }
        }

        // Terms Functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function acceptTerms() {
            if (!currentUser) return;
            
            const userIndex = players.findIndex(p => p.id === currentUser.id);
            if (userIndex !== -1) {
                players[userIndex].agreedToTerms = true;
                currentUser.agreedToTerms = true;
                saveData();
                closeModal('termsModal');
                alert('Terms accepted! You can now participate in bets and lotteries.');
            }
        }

        // Update Home Page Stats
        function updateHomePage() {
            const totalMoney = bets.reduce((sum, bet) => sum + (bet.moneyValue || bet.amount || 0), 0);
            const activeBetsCount = bets.filter(b => ['waiting', 'pending_payment'].includes(b.status)).length;
            const unpaidCount = bets.filter(b => b.status === 'pending_payment').length;
            
            document.getElementById('totalMoney').textContent = '$' + totalMoney;
            document.getElementById('totalPlayers').textContent = players.length;
            document.getElementById('activeBets').textContent = activeBetsCount;
            document.getElementById('unpaidBets').textContent = unpaidCount;
            
            if (currentUser) {
                document.getElementById('loginPrompt').classList.add('hidden');
                document.getElementById('userWelcome').classList.remove('hidden');
                document.getElementById('welcomeName').textContent = currentUser.displayName;
            } else {
                document.getElementById('loginPrompt').classList.remove('hidden');
                document.getElementById('userWelcome').classList.add('hidden');
            }
        }

        // Update User Info in Header
        function updateUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            
            if (currentUser) {
                userInfoDiv.innerHTML = `
                    <span style="margin-right: 20px; color: #FFD700">
                        Welcome, <strong>${currentUser.displayName}</strong>
                    </span>
                    <button onclick="logout()" class="btn">Logout</button>
                `;
            } else {
                userInfoDiv.innerHTML = `
                    <button onclick="showPage('login')" class="btn">Login / Register</button>
                `;
            }
        }

        // Initialize
        function init() {
            // Initialize lottery tiers if not exists
            if (lotteryTiers.length === 0) {
                lotteryTiers = [
                    { id: 1, name: "Bronze Tier", price: 50, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
                    { id: 2, name: "Silver Tier", price: 150, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
                    { id: 3, name: "Gold Tier", price: 300, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" },
                    { id: 4, name: "Diamond Tier", price: 500, totalTickets: 100, soldTickets: 0, players: [], status: "waiting" }
                ];
                saveData();
            }
            
            // Show home page
            showPage('home');
        }

        // Start the app
        init();
    </script>
</body>
</html>
